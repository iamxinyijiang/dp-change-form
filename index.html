<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PO Amendment Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    label, select, input, textarea { display: block; margin: 10px 0; }
    textarea { width: 100%; height: 300px; }
  </style>
</head>
<body>
  <h2>PO Amendment Generator</h2>

  <label for="po">PO Number:</label>
  <input type="text" id="po" placeholder="e.g., 8503897644">

  <label for="location">Location:</label>
  <select id="location">
    <option value="">-- Select Location --</option>
    <option value="Prestons">Prestons</option>
    <option value="Minchinbury">Minchinbury</option>
    <option value="Regency Park">Regency Park</option>
    <option value="Derrimut">Derrimut</option>
    <option value="Dandenong">Dandenong</option>
    <option value="Brendale">Brendale</option>
    <option value="Stapylton">Stapylton</option>
  </select>

  <label>Current Quantities:</label>
  <input type="number" id="gtin1" placeholder="4061 4635 16428 - Qty (5 units/DP)">
  <input type="number" id="gtin2" placeholder="4061 4635 15865 - Qty (2 units/DP)">
  <input type="number" id="gtin3" placeholder="4061 4617 55737 - Qty (5 units/DP)">

  <label for="name">Your Name (for sign-off):</label>
  <input type="text" id="name" placeholder="e.g., Xinyi Jiang">

  <button onclick="generateText()">Generate Email</button>
  <textarea id="output" readonly></textarea>

  <script>
    const targetDPs = {
      'Prestons': 120,
      'Minchinbury': 120,
      'Regency Park': 132,
      'Derrimut': 204,
      'Dandenong': 204,
      'Brendale': 120,
      'Stapylton': 120
    };

    function generateText() {
      const po = document.getElementById('po').value.trim();
      const location = document.getElementById('location').value;
      const gtin1 = parseInt(document.getElementById('gtin1').value || 0);
      const gtin2 = parseInt(document.getElementById('gtin2').value || 0);
      const gtin3 = parseInt(document.getElementById('gtin3').value || 0);
      const name = document.getElementById('name').value.trim();

      const dp1 = gtin1 / 5;
      const dp2 = gtin2 / 2;
      const dp3 = gtin3 / 5;

      if (!Number.isInteger(dp1) || !Number.isInteger(dp2) || !Number.isInteger(dp3)) {
        alert("All quantities must result in full DPs (no remainder). GTIN1 & GTIN3 divisible by 5, GTIN2 by 2.");
        return;
      }

      const currentDP = dp1 + dp2 + dp3;
      const targetDP = targetDPs[location] || currentDP;
      const ratio = targetDP / currentDP;

      let newDP1 = Math.round(dp1 * ratio);
      let newDP2 = Math.round(dp2 * ratio);
      let newDP3 = Math.round(dp3 * ratio);

      // Fine-tune rounding
      let totalDP = newDP1 + newDP2 + newDP3;
      let diff = targetDP - totalDP;

      while (diff !== 0) {
        if (diff > 0) {
          if (diff >= 1) { newDP1++; diff--; }
        } else {
          if (diff <= -1 && newDP1 > 0) { newDP1--; diff++; }
        }
        totalDP = newDP1 + newDP2 + newDP3;
        if (Math.abs(diff) > 10) break;
      }

      const newQ1 = newDP1 * 5;
      const newQ2 = newDP2 * 2;
      const newQ3 = newDP3 * 5;

      const subject = `PO ${po} â€“ Amendment Request - ${targetDP < currentDP ? 'over' : 'under'} MOQ`;
      const header = `Hi Team,\n\nPlease find attached PO ${po} for ${location}. The order currently has ${currentDP} DP, which is ${targetDP < currentDP ? 'over' : 'under'} the target load of ${targetDP} DP for ${location}.\nPlease kindly change it as the following, so the total is ${targetDP} DP.\n\n`;

      const table = `GTIN                                               Quantity\n` +
        `4061 4635 16428                      ${gtin1 > newQ1 ? 'Decrease' : 'Increase'} From ${gtin1} to ${newQ1}             =    ${newDP1} dp\n` +
        `4061 4635 15865                      ${gtin2 > newQ2 ? 'Decrease' : 'Increase'} From ${gtin2} to ${newQ2}             =    ${newDP2} dp\n` +
        `4061 4617 55737                      ${gtin3 > newQ3 ? 'Decrease' : 'Increase'} From ${gtin3} to ${newQ3}             =    ${newDP3} dp\n` +
        `                                                                                                            ___________\n` +
        `                                                                                  T o t a l                              ${targetDP} dp\n` +
        `                                                                                                            ========\n`;

      const signoff = `\n\nThank you.\n\nKind regards,\n${name}`;

      document.getElementById('output').value = subject + "\n\n" + header + table + signoff;
    }
  </script>
</body>
</html>
